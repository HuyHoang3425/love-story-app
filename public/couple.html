<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <!-- couple.html -->
  <body>
    <div class="container">
      <h2>Nh·∫≠p m√£ Couple Code</h2>
      <input type="text" id="coupleCode" placeholder="Nh·∫≠p m√£..." />
      <button btn-send>G·ª≠i</button>

      <table class="management-table">
        <thead>
          <tr>
            <th>Y√™u c·∫ßu ƒë√£ g·ª≠i</th>
            <th>Y√™u c·∫ßu nh·∫≠n ƒë∆∞·ª£c</th>
            <th>ƒêang k·∫øt n·ªëi</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <!-- Y√™u c·∫ßu ƒë√£ g·ª≠i -->
            <td body-request></td>

            <!-- Y√™u c·∫ßu nh·∫≠n ƒë∆∞·ª£c -->
            <td body-accept></td>

            <!-- ƒêang k·∫øt n·ªëi -->
            <td>
              <div class="user-info">
                <div class="user-avatar">M</div>
                <div class="user-details">
                  <strong>mybaby</strong><br />
                  <small>K·∫øt n·ªëi t·ª´: 15/01/2024</small>
                </div>
                <div class="user-actions">
                  <button class="btn btn-disconnect">Ng·∫Øt k·∫øt n·ªëi</button>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const token = localStorage.getItem('token')
        if (!token) {
          alert('Vui l√≤ng ƒëƒÉng nh·∫≠p')
          window.location.href = '/login.html'
          return
        }

        try {
          const res = await fetch('http://localhost:3000/api/v1/couple/request', {
            method: 'GET',
            headers: {
              Authorization: `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          })

          const contentType = res.headers.get('content-type')
          if (contentType && contentType.includes('application/json')) {
            const data = await res.json()
            console.log('DATA:', data)
            await document.querySelector('[btn-send]').setAttribute('userId', data.data.userId)
            await renderRequest(data.data)
            await renderAccept(data.data)
          } else {
            const text = await res.text()
            console.warn('Server tr·∫£ v·ªÅ HTML:\n', text)
          }
        } catch (err) {
          console.error('L·ªói khi l·∫•y d·ªØ li·ªáu couple:', err)
        }
      })

      // üü¢ Render ng∆∞·ªùi b·∫°n ƒë√£ g·ª≠i l·ªùi m·ªùi
      async function renderRequest(data) {
        const bodyRequest = document.querySelector('[body-request]')
        if (!bodyRequest) return

        const list = Array.isArray(data?.requestFriends) ? data.requestFriends : []
        bodyRequest.innerHTML = ''

        for (const user of list) {
          const divUser = document.createElement('div')
          divUser.classList.add('user-info')
          divUser.innerHTML = `
            <div class="user-avatar">U</div>
            <div class="user-details">
              <strong>${user.username}</strong>
            </div>
            <div class="user-actions">
              <button class="btn btn-cancel" btn-cancel="${user._id}">Hu·ª∑</button>
            </div>
          `
          bodyRequest.appendChild(divUser)
        }
      }

      // üü¢ Render ng∆∞·ªùi ƒë√£ g·ª≠i l·ªùi m·ªùi cho b·∫°n (b·∫°n c√≥ th·ªÉ ch·∫•p nh·∫≠n / t·ª´ ch·ªëi)
      async function renderAccept(data) {
        const bodyAccept = document.querySelector('[body-accept]')
        if (!bodyAccept) return

        const list = Array.isArray(data?.acceptFriends) ? data.acceptFriends : []
        bodyAccept.innerHTML = ''

        for (const user of list) {
          const divUser = document.createElement('div')
          divUser.classList.add('user-info')
          divUser.innerHTML = `
            <div class="user-avatar">S</div>
            <div class="user-details">
              <strong>${user.username}</strong>
            </div>
            <div class="user-actions">
              <button class="btn btn-accept" btn-accept data-id="${user._id}">Ch·∫•p nh·∫≠n</button>
              <button class="btn btn-cancel" btn-refuse="${user._id}">T·ª´ ch·ªëi</button>
            </div>
          `
          bodyAccept.appendChild(divUser)
        }
        CancelFriends()
      }
      var socket = io()

      const input = document.querySelector('input')
      const button = document.querySelector('[btn-send]')
      button.addEventListener('click', () => {
        const userId = button.getAttribute('userId')
        const coupleCode = input.value
        console.log(input.value)
        socket.emit('USER_REQUEST_FRIEND', {
          userId,
          coupleCode
        },(ack) =>{
          if(ack.status === "success"){
            console.log("thanh cong")
          }else{
            console.log("that bai")
          }
        })
        input.value = ''
      })
      //hi·ªÉn th·ªã nh·ªØng ng∆∞·ªùi m√¨nh g·ª≠i y√™u c·∫ßu
      socket.on('SERVER_RETURN_USER_REQUEST', (data) => {
        const bodyRequest = document.querySelector('[body-request]')
        if (bodyRequest) {
          if (button.getAttribute('userId') == data.myUserId) {
            const divUser = document.createElement('div')
            divUser.classList.add('user-info')
            divUser.innerHTML = `
      <div class="user-avatar">U</div>
        <div class="user-details"><strong>${data.userName}</strong></div>
        <div class="user-actions">
        <button class="btn btn-cancel" btn-cancel="${data.userId}">Hu·ª∑</button>
      </div>
      `
            bodyRequest.appendChild(divUser)
          }
        }

        CancelFriends()
      })

      //hi·ªÉn th·ªã nh∆∞ng ng∆∞·ªùi g·ª≠i ƒë·∫øn cho b·∫°n
      socket.on('SERVER_RETURN_USER_ACCEPT', (data) => {
        console.log(data)
        const bodyAccept = document.querySelector('[body-accept]')
        if (bodyAccept) {
          if (button.getAttribute('userId') == data.myUserId) {
            const divUser = document.createElement('div')
            divUser.classList.add('user-info')
            divUser.innerHTML = `
            <div class="user-avatar">S</div>
            <div class="user-details">
              <strong>${data.userName}</strong>
            </div>
            <div class="user-actions">
              <button class="btn btn-accept" btn-accept data-id="${data.userId}">Ch·∫•p nh·∫≠n</button>
              <button class="btn btn-cancel" btn-refuse="${data.userId}">T·ª´ ch·ªëi</button>
            </div>
            `
            bodyAccept.appendChild(divUser)
          }
        }
      })

      //b·∫Øt l·ªói
      socket.on('ERROR', (data) => {
        console.log(data)
      })

      //hu·ª∑ k·∫øt b·∫°n
      const CancelFriends = () => {
        const btnCancels = document.querySelectorAll('[btn-cancel]')
        if (btnCancels.length > 0) {
          btnCancels.forEach((btn) => {
            btn.addEventListener('click', () => {
              const myUserId = button.getAttribute('userId')
              const userId = btn.getAttribute('btn-cancel')
              socket.emit('USER_CANCEL_FRIEND', {
                myUserId,
                userId
              })
            })
          })
        }
      }
      CancelFriends()

      //xo√° nh·ªØng ng∆∞·ªùi m√¨nh hu·ª∑ y√™u c·∫ßu
      socket.on('SERVER_RETURN_USER_CANCEL', (data) => {
        const bodyRequest = document.querySelector('[body-request]')
        const myUserId = button.getAttribute('userId')

        if (bodyRequest && myUserId == data.myUserId) {
          const btn = document.querySelector(`[btn-cancel='${data.userId}']`)
          if (btn) {
            const boxUser = btn.closest('.user-info')
            if (boxUser) {
              bodyRequest.removeChild(boxUser)
            }
          }
        }
      })

      //t·ª´ ch·ªëi k·∫øt b·∫°n
      const btnRefuse = document.querySelectorAll('[btn-refuse]')
      if (btnRefuse.length > 0) {
        btnRefuse.forEach((btn) => {
          btn.addEventListener('click', () => {
            const myUserId = button.getAttribute('userId')
            const userId = btn.getAttribute('btn-refuse')
            socket.emit('USER_REFUSE_FRIEND', {
              myUserId,
              userId
            })
          })
        })
      }
    </script>
    <!-- <script src="app.js"></script> -->
  </body>
</html>
